@using ElectronicsStore
@using ElectronicsStore.Models
@using ElectronicsStore.Domain.ViewModels
@using ElectronicsStore.Domain.Entity
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@model ElectronicsStore.Models.GetProductViewModel

@{
    ViewData["Title"] = Model?.Name;
}

<div class="container mt-5 mb-5">
    <div class="row">
        @* Левая колонка с изображением *@
        <div class="col-md-6 mb-4 d-flex align-items-center justify-content-center p-3 border rounded bg-light">
            @if (!string.IsNullOrEmpty(Model?.ImageUrl))
            {
                <img src="@Model.ImageUrl" alt="@Model.Name" class="img-fluid" style="max-height: 500px; object-fit: contain;">
            }
            else
            {
                <img src="/img/w.png" alt="Нет изображения" class="img-fluid" style="max-height: 500px;">
            }
        </div>

        @* Правая колонка с информацией *@
        <div class="col-md-6">
            <h1 class="display-5 fw-bold">@Model?.Name</h1>

            <p class="text-muted mb-4">Категория: @(Model?.CategoryName ?? "Не указана")</p>

            <h2 class="text-primary mb-4">@Model?.Price.ToString("C0")</h2>

            <hr />

            <h4 class="mt-4">Описание товара</h4>
            <p class="lead" style="font-size: 1.1rem;">
                @(Model?.Description ?? "Описание отсутствует.")
            </p>

            @if (Model?.ReviewsCount > 0)
            {
                <div class="mb-4">
                    <span class="badge bg-success fs-6">Рейтинг: @Model.AverageRating</span>
                    <span class="text-muted ms-2">(@Model.ReviewsCount отзывов)</span>
                </div>
            }

            <div class="mt-5 d-grid gap-2 d-md-block">
                @* --- ЛОГИКА КНОПКИ КОРЗИНЫ --- *@
                @if (User.Identity != null && User.Identity.IsAuthenticated)
                {
                    // Если пользователь ВОШЕЛ -> отправляем запрос в CartController
                    <a asp-controller="Cart" asp-action="Add" asp-route-id="@Model?.Id" class="btn btn-primary btn-lg px-5 me-md-2">
                        Добавить в корзину
                    </a>
                }
                else
                {
                    // Если пользователь НЕ ВОШЕЛ -> открываем модальное окно (Login Modal)
                    // Важно: data-bs-target="#modal" должен совпадать с ID вашего окна входа
                    <button type="button" class="btn btn-primary btn-lg px-5 me-md-2" onclick="openLoginModal()">
                        Добавить в корзину
                    </button>
                }

                <a asp-controller="Home" asp-action="Index" class="btn btn-outline-secondary btn-lg px-5">На главную</a>
            </div>
        </div>
    </div>

    @* Секция отзывов *@
    @if (Model?.Reviews != null && Model.Reviews.Count > 0)
    {
        <div class="row mt-5">
            <div class="col-12">
                <h3>Отзывы покупателей</h3>
                <hr />
                <div class="list-group list-group-flush">
                    @foreach (var review in Model.Reviews)
                    {
                        <div class="list-group-item py-3">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">@review.User?.Name</h5>
                                <small class="text-muted">@review.CreatedAt.ToString("dd.MM.yyyy")</small>
                            </div>
                            <p class="mb-1">
                                Оценка: <span class="fw-bold text-primary">@review.Rating/5</span>
                            </p>
                            <p class="mb-1">@review.Content</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    }
</div>

@* Скрипт для открытия окна входа *@
<script>
    function openLoginModal() {
        // Пробуем найти кнопку входа в шапке сайта и "нажать" на неё программно
        // Обычно у кнопки входа есть ID или атрибуты.
        // Если у вас модальное окно имеет id="modal", можно вызвать его так:

        var loginModal = new bootstrap.Modal(document.getElementById('modal'));
        loginModal.show();

        // Или если окно называется иначе, попробуйте найти кнопку входа в навбаре:
        // document.querySelector('a[href="/Account/Login"]').click();
    }
</script>