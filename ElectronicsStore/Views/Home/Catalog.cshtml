@model ElectronicsStore.Domain.ViewModels.CatalogViewModel

@{
    ViewData["Title"] = Model.IsMainCatalogPage ? "Каталог" : Model.CurrentCategoryName;

    var allProductNames = Model.Products.Select(p => p.Name).Distinct().OrderBy(n => n).ToList();

    // Приводим к нижнему регистру для надежной проверки
    string catName = Model.CurrentCategoryName.ToLower();
    bool isComputerCategory = catName.Contains("комп") || catName.Contains("ноут") || catName.Contains("пк");

    bool showCategorySelector = Model.Filter.CategoryId == 0;
}

<div class="catalog-wrapper">
    <div class="container py-5">

        @if (Model.IsMainCatalogPage)
        {
            /* === ГЛАВНАЯ СТРАНИЦА КАТАЛОГА (Плитки) === */
            <div class="text-center mb-5 fade-in">
                <h1 class="display-4 fw-bold text-white text-uppercase mb-4 title-glow">
                    Каталог <span class="text-orange">Electronics</span>
                </h1>
                <div class="row justify-content-center">
                    <div class="col-md-8 col-lg-6">
                        <div class="search-container position-relative">
                            <input type="text" id="globalSearchInput"
                                   class="form-control form-control-lg custom-search-input ps-5 pe-5"
                                   placeholder="Поиск товара..." autocomplete="off">
                            <span class="search-icon-left">🔍</span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="categoriesBlock" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 justify-content-center fade-in-up">
                @foreach (var cat in Model.Categories)
                {
                    <div class="col">
                        <a href="@Url.Action("Catalog", new { CategoryId = cat.Id })" class="text-decoration-none category-card-link">
                            <div class="card h-100 category-big-card bg-dark-card text-center p-4">
                                <div class="icon-big mb-3">
                                    @* === ИСПРАВЛЕННАЯ ЛОГИКА ИКОНОК (ToLower) === *@
                                    @if (cat.Name.ToLower().Contains("смартфон") || cat.Name.ToLower().Contains("телефон"))
                                    {
                                        <span>📱</span>
                                    }
                                    else if (cat.Name.ToLower().Contains("комп") || cat.Name.ToLower().Contains("ноут") || cat.Name.ToLower().Contains("пк"))
                                    {
                                        <span>💻</span>
                                    }
                                    else if (cat.Name.ToLower().Contains("монитор"))
                                    {

                                        <span>📺</span>
                                    }
                                    else if (cat.Name.ToLower().Contains("периферия") || cat.Name.ToLower().Contains("аксессуар"))
                                    {

                                        <span>🎧</span>
                                    }
                                    else if (cat.Name.ToLower().Contains("планшет"))
                                    {

                                        <span>📲</span>
                                    }
                                    else
                                    {

                                        <span>📦</span>
                                    }
                                </div>
                                <h3 class="text-white fw-bold">@cat.Name</h3>
                            </div>
                        </a>
                    </div>
                }
                <div class="col">
                    <a href="@Url.Action("Catalog", new { CategoryId = 0, showAll = true })" class="text-decoration-none category-card-link">
                        <div class="card h-100 category-big-card bg-gradient-orange text-center p-4 border-0">
                            <div class="icon-big mb-3 text-black">🚀</div>
                            <h3 class="text-black fw-bold">Все товары</h3>
                        </div>
                    </a>
                </div>
            </div>
            <div id="globalSearchResults" class="row row-cols-1 row-cols-sm-2 row-cols-xl-3 g-4 fade-in-up" style="display: none;"></div>
        }
        else
        {
            /* === СПИСОК ТОВАРОВ + ФИЛЬТРЫ === */
            <div class="d-flex align-items-center mb-4 fade-in">
                <a href="@Url.Action("Catalog")" class="btn-back me-3">🠔</a>
                <div>
                    <small class="text-orange d-block mb-1 fw-bold text-uppercase">Раздел</small>
                    <h2 class="text-white fw-bold text-uppercase m-0 text-shadow">@Model.CurrentCategoryName</h2>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-3 mb-4 fade-in-up">
                    <div class="filter-panel sticky-top">
                        <div class="filter-header mb-4">
                            <h5 class="text-white m-0 fw-bold">⚡ Фильтры</h5>
                        </div>

                        <form id="filterForm" onsubmit="event.preventDefault();">

                            @if (showCategorySelector)
                            {
                                <div class="mb-4">
                                    <label class="filter-label">Категория</label>
                                    <select id="categorySelect" class="form-select custom-input" onchange="applyFilter('sidebar')">
                                        <option value="0">Все категории</option>
                                        @foreach (var cat in Model.Categories)
                                        {
                                            var isSelected = cat.Id == Model.Filter.CategoryId;
                                            <!option value="@cat.Id" @(isSelected ? "selected" : "")>@cat.Name</!option>
                                        }
                                    </select>
                                </div>
                            }
                            else
                            {
                                <input type="hidden" id="categorySelect" value="@Model.Filter.CategoryId" />
                            }

                            @if (isComputerCategory)
                            {
                                <div class="mb-4 fade-in">
                                    <label class="filter-label">Тип устройства</label>
                                    <select id="typeSelect" class="form-select custom-input" onchange="applyTypeFilter(this.value)">
                                        <option value="">Все типы</option>
                                        <option value="Ноутбук">Только Ноутбуки</option>
                                        <option value="ПК">Только ПК</option>
                                    </select>
                                </div>
                            }

                            <div class="mb-4">
                                <label class="filter-label">Модель</label>
                                <select id="modelSelect" class="form-select custom-input" onchange="applyModelFilter(this.value)">
                                    <option value="">Любая модель</option>
                                    @foreach (var name in allProductNames)
                                    {
                                        <option value="@name">@name</option>
                                    }
                                </select>
                            </div>

                            <div class="mb-4">
                                <label class="filter-label">Поиск</label>
                                <input type="text" id="nameInput" class="form-control custom-input"
                                       placeholder="Название..." value="@Model.Filter.Name">
                            </div>

                            <div class="mb-4">
                                <label class="filter-label">Цена (₽)</label>
                                <div class="d-flex gap-2 align-items-center">
                                    <input type="number" id="minPrice" class="form-control custom-input text-center" placeholder="0" value="@Model.Filter.MinPrice">
                                    <span class="text-muted">-</span>
                                    <input type="number" id="maxPrice" class="form-control custom-input text-center" placeholder="MAX" value="@Model.Filter.MaxPrice">
                                </div>
                            </div>

                            <button type="button" onclick="resetFilters()" class="btn btn-outline-orange w-100 btn-sm fw-bold">
                                🗑️ Сбросить
                            </button>
                        </form>
                    </div>
                </div>

                <div class="col-lg-9">
                    <div id="productsContainer" class="row row-cols-1 row-cols-sm-2 row-cols-xl-3 g-4 fade-in-up">
                        @await Html.PartialAsync("_ProductListPartial", Model.Products)
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<style>
    :root {
        --main-bg: #050505;
        --card-bg: #141414;
        --input-bg: #1f1f1f;
        --orange: #ff6600;
        --border-color: #333;
    }

    .catalog-wrapper {
        background-color: var(--main-bg);
        min-height: 100vh;
        font-family: 'Segoe UI', sans-serif;
    }

    .text-orange {
        color: var(--orange) !important;
    }

    .title-glow {
        text-shadow: 0 0 20px rgba(255, 102, 0, 0.3);
    }

    .custom-search-input {
        background: #1a1a1a;
        border: 2px solid #333;
        border-radius: 50px;
        color: white;
        height: 60px;
    }

        .custom-search-input:focus {
            border-color: var(--orange);
            box-shadow: 0 0 15px rgba(255, 102, 0, 0.3);
            color: white;
            background: #222;
        }

    .search-icon-left {
        position: absolute;
        left: 20px;
        top: 18px;
        font-size: 1.2rem;
        opacity: 0.5;
    }

    .bg-dark-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 20px;
        transition: 0.3s;
    }

    .bg-gradient-orange {
        background: linear-gradient(135deg, #ff6600, #ff9900);
        border-radius: 20px;
    }

    .category-card-link:hover .bg-dark-card {
        transform: translateY(-7px);
        border-color: var(--orange);
    }

    .icon-big {
        font-size: 3.5rem;
        transition: 0.3s;
    }

    .filter-panel {
        background: var(--card-bg);
        border-radius: 16px;
        padding: 25px;
        border: 1px solid var(--border-color);
    }

    .filter-label {
        color: #888;
        font-size: 0.8rem;
        text-transform: uppercase;
        margin-bottom: 5px;
        font-weight: bold;
    }

    .custom-input {
        background: var(--input-bg);
        border: 1px solid var(--border-color);
        color: white;
        border-radius: 8px;
    }

        .custom-input:focus {
            border-color: var(--orange);
            background: #252525;
            color: white;
        }

    select.custom-input {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23ff6600' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 12px 10px;
    }

    .btn-outline-orange {
        color: var(--orange);
        border: 1px solid var(--orange);
        transition: 0.3s;
    }

        .btn-outline-orange:hover {
            background: var(--orange);
            color: white;
        }

    .btn-back {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
    }

    .fade-in {
        animation: fadeIn 0.6s ease-out;
    }

    .fade-in-up {
        animation: fadeInUp 0.6s ease-out;
    }

    @@keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

<script>
    function resetFilters() {
        document.getElementById('nameInput').value = "";
        document.getElementById('minPrice').value = "";
        document.getElementById('maxPrice').value = "";

        const catSelect = document.getElementById('categorySelect');
        if(catSelect && catSelect.tagName === 'SELECT') { catSelect.value = "0"; }

        if(document.getElementById('typeSelect')) document.getElementById('typeSelect').value = "";
        if(document.getElementById('modelSelect')) document.getElementById('modelSelect').value = "";
        applyFilter('sidebar');
    }

    function applyTypeFilter(val) {
        document.getElementById('nameInput').value = val;
        if(document.getElementById('modelSelect')) document.getElementById('modelSelect').value = "";
        applyFilter('sidebar');
    }

    function applyModelFilter(val) {
        document.getElementById('nameInput').value = val;
        if(document.getElementById('typeSelect')) document.getElementById('typeSelect').value = "";
        applyFilter('sidebar');
    }

    async function applyFilter(source) {
        let data = {};
        let containerId = "";

        if (source === 'global') {
            const query = document.getElementById('globalSearchInput').value;
            const categoriesBlock = document.getElementById('categoriesBlock');
            const resultsBlock = document.getElementById('globalSearchResults');

            if (!query || query.trim() === "") {
                categoriesBlock.style.display = 'flex';
                resultsBlock.style.display = 'none';
                return;
            } else {
                categoriesBlock.style.display = 'none';
                resultsBlock.style.display = 'flex';
                containerId = 'globalSearchResults';
                data = { CategoryId: 0, Name: query };
            }
        } else {
            containerId = 'productsContainer';
            data = {
                CategoryId: parseInt(document.getElementById('categorySelect')?.value || 0),
                Name: document.getElementById('nameInput')?.value || "",
                MinPrice: document.getElementById('minPrice')?.value ? parseFloat(document.getElementById('minPrice').value) : null,
                MaxPrice: document.getElementById('maxPrice')?.value ? parseFloat(document.getElementById('maxPrice').value) : null,
                SortType: ""
            };
        }

        try {
            const container = document.getElementById(containerId);
            if(container) {
                container.style.opacity = '0.5';
                const response = await fetch('/Home/Filter', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (response.ok) {
                    container.innerHTML = await response.text();
                }
                container.style.opacity = '1';
            }
        } catch (e) { console.error(e); }
    }

    function debounce(func, timeout = 500) {
        let timer;
        return (...args) => { clearTimeout(timer); timer = setTimeout(() => { func.apply(this, args); }, timeout); };
    }

    document.addEventListener("DOMContentLoaded", function () {
        const globalInput = document.getElementById('globalSearchInput');
        if (globalInput) globalInput.addEventListener('input', debounce(() => applyFilter('global'), 500));

        const sidebarInput = document.getElementById('nameInput');
        if (sidebarInput) sidebarInput.addEventListener('input', debounce(() => applyFilter('sidebar'), 500));

        document.getElementById('minPrice')?.addEventListener('input', debounce(() => applyFilter('sidebar'), 800));
        document.getElementById('maxPrice')?.addEventListener('input', debounce(() => applyFilter('sidebar'), 800));
    });
</script>