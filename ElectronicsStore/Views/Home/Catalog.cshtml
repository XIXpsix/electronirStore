@model ElectronicsStore.Domain.ViewModels.CatalogViewModel

@{
    ViewData["Title"] = Model.IsMainCatalogPage ? "Каталог" : Model.CurrentCategoryName;
}

<div class="container-fluid" style="background-color: #050505; min-height: 100vh;">
    <div class="container py-5">

        @if (Model.IsMainCatalogPage)
        {
            /* === ГЛАВНАЯ КАТАЛОГА === */

            <div class="text-center mb-5 fade-in">
                <h1 class="text-white fw-bold text-uppercase mb-4">Каталог товаров</h1>

                <div class="row justify-content-center">
                    <div class="col-md-8 col-lg-6">
                        <div class="position-relative">
                            <input type="text" id="globalSearchInput" class="form-control form-control-lg bg-dark text-white border-secondary rounded-pill ps-4 pe-5"
                                   placeholder="Начните вводить название товара..." style="height: 60px; font-size: 1.2rem; box-shadow: 0 0 15px rgba(0,0,0,0.5);">
                            <span class="position-absolute" style="right: 20px; top: 18px; font-size: 1.5rem; opacity: 0.5;">🔍</span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="categoriesBlock" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 justify-content-center fade-in-up">
                @foreach (var cat in Model.Categories)
                {
                    <div class="col">
                        <a href="@Url.Action("Catalog", new { CategoryId = cat.Id })" class="text-decoration-none category-card-link">
                            <div class="card h-100 category-big-card bg-dark-card text-center p-4">
                                <div class="icon-big mb-3">
                                    @(cat.Name.ToLower().Contains("телефон") ? "📱" :
                                                                cat.Name.ToLower().Contains("комп") ? "💻" :
                                                                cat.Name.ToLower().Contains("монитор") ? "🖥️" :
                                                                cat.Name.ToLower().Contains("аксессуар") ? "🎧" : "📦")
                        </div>
                        <h3 class="text-white fw-bold">@cat.Name</h3>
                        <p class="text-muted">Смотреть товары</p>
                    </div>
                </a>
            </div>
                        }
                <div class="col">
                    <a href="@Url.Action("Catalog", new { CategoryId = 0, Name = "" })" class="text-decoration-none category-card-link">
                        <div class="card h-100 category-big-card bg-main-orange-gradient text-center p-4 border-0">
                            <div class="icon-big mb-3 text-black">🚀</div>
                            <h3 class="text-black fw-bold">Все товары</h3>
                            <p class="text-black-50">Полный список</p>
                        </div>
                    </a>
                </div>
            </div>

            <div id="globalSearchResults" class="row row-cols-1 row-cols-sm-2 row-cols-xl-3 g-4 fade-in-up" style="display: none;">
            </div>
        }
        else
        {
            /* === СТРАНИЦА КАТЕГОРИИ / СПИСОК ТОВАРОВ === */

            <div class="d-flex align-items-center mb-4 fade-in">
                <a href="@Url.Action("Catalog")" class="btn btn-outline-secondary me-3 rounded-circle"
                   style="width: 40px; height: 40px; display:flex; align-items:center; justify-content:center; text-decoration:none;">🠔</a>

                <div>
                    <small class="text-muted d-block mb-1">Раздел:</small>
                    <h2 class="text-white fw-bold text-uppercase m-0">@Model.CurrentCategoryName</h2>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-3 mb-4 fade-in-up">
                    <div class="filter-card p-4 rounded bg-dark-card border border-secondary sticky-top" style="top: 20px; z-index: 100;">
                        <h5 class="text-white mb-3">Фильтры</h5>

                        <form id="filterForm" onsubmit="event.preventDefault();">
                            <div class="mb-3">
                                <label class="text-muted mb-1 small">Категория</label>
                                <select id="categorySelect" class="form-select bg-dark text-white border-secondary">
                                    <option value="0">Все категории</option>
                                    @foreach (var cat in Model.Categories)
                                    {
                                        var isSelected = cat.Id == Model.Filter.CategoryId;
                                        <!option value="@cat.Id" @(isSelected ? "selected" : "")>@cat.Name</!option>
                                    }
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="text-muted mb-1 small">Поиск</label>
                                <input type="text" id="nameInput" class="form-control bg-dark text-white border-secondary"
                                       placeholder="Название..." value="@Model.Filter.Name">
                            </div>

                            <hr class="border-secondary my-3">

                            <div class="mb-3">
                                <label class="text-muted mb-1 small">Цена (₽)</label>
                                <div class="d-flex gap-2">
                                    <input type="number" id="minPrice" class="form-control bg-dark text-white border-secondary" placeholder="От" value="@Model.Filter.MinPrice">
                                    <input type="number" id="maxPrice" class="form-control bg-dark text-white border-secondary" placeholder="До" value="@Model.Filter.MaxPrice">
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="text-muted mb-1 small">Сортировка</label>
                                <select id="sortSelect" class="form-select bg-dark text-white border-secondary">
                                    <!option value="" @(Model.Filter.SortType == "" ? "selected" : "")>По новизне</!option>
                                    <!option value="price_asc" @(Model.Filter.SortType == "price_asc" ? "selected" : "")>Сначала дешевые</!option>
                                    <!option value="price_desc" @(Model.Filter.SortType == "price_desc" ? "selected" : "")>Сначала дорогие</!option>
                                    <!option value="name_asc" @(Model.Filter.SortType == "name_asc" ? "selected" : "")>А-Я</!option>
                                </select>
                            </div>

                            <a href="@Url.Action("Catalog")" class="btn btn-outline-secondary w-100 btn-sm">Сбросить всё</a>
                        </form>
                    </div>
                </div>

                <div class="col-lg-9">
                    <div id="productsContainer" class="row row-cols-1 row-cols-sm-2 row-cols-xl-3 g-4 fade-in-up">
                        @await Html.PartialAsync("_ProductListPartial", Model.Products)
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<style>
    .bg-dark-card {
        background-color: #1e1e1e;
    }

    .category-big-card {
        border: 1px solid #333;
        border-radius: 15px;
        transition: all 0.3s ease;
    }

    .category-card-link:hover .category-big-card {
        transform: translateY(-7px);
        border-color: #ff6600;
        box-shadow: 0 10px 30px rgba(255, 102, 0, 0.2);
    }

    .icon-big {
        font-size: 3.5rem;
        transition: transform 0.3s;
    }

    .category-card-link:hover .icon-big {
        transform: scale(1.1);
    }

    .bg-main-orange-gradient {
        background: linear-gradient(45deg, #ff6600, #ff8533);
    }

    .fade-in {
        animation: fadeIn 0.6s ease-out;
    }

    .fade-in-up {
        animation: fadeInUp 0.6s ease-out;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    @@keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

<script>
    // Главная функция фильтрации
    async function applyFilter(source) {
        let data = {};
        let containerId = "";

        // Определяем, откуда пришел запрос (Главная или Сайдбар)
        if (source === 'global') {
            const query = document.getElementById('globalSearchInput').value;

            // Логика переключения видимости на главной
            const categoriesBlock = document.getElementById('categoriesBlock');
            const resultsBlock = document.getElementById('globalSearchResults');

            if (!query || query.trim() === "") {
                // Если пусто - показываем категории, скрываем результаты
                categoriesBlock.style.display = 'flex';
                resultsBlock.style.display = 'none';
                return; // Не делаем запрос
            } else {
                // Если есть текст - скрываем категории, показываем результаты
                categoriesBlock.style.display = 'none';
                resultsBlock.style.display = 'flex';
                containerId = 'globalSearchResults';

                // Данные для фильтра
                data = { CategoryId: 0, Name: query, MinPrice: null, MaxPrice: null, SortType: "" };
            }
        }
        else {
            // Логика для сайдбара
            containerId = 'productsContainer';
            data = {
                CategoryId: parseInt(document.getElementById('categorySelect')?.value || 0),
                Name: document.getElementById('nameInput')?.value || "",
                MinPrice: document.getElementById('minPrice')?.value ? parseFloat(document.getElementById('minPrice').value) : null,
                MaxPrice: document.getElementById('maxPrice')?.value ? parseFloat(document.getElementById('maxPrice').value) : null,
                SortType: document.getElementById('sortSelect')?.value || ""
            };
        }

        try {
            // Делаем загрузку полупрозрачной, чтобы было видно процесс
            const container = document.getElementById(containerId);
            container.style.opacity = '0.5';

            const response = await fetch('/Home/Filter', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                container.innerHTML = await response.text();
            }
            container.style.opacity = '1';
        } catch (e) {
            console.error(e);
        }
    }

    // Универсальная функция задержки (debounce)
    function debounce(func, timeout = 500) {
        let timer;
        return (...args) => {
            clearTimeout(timer);
            timer = setTimeout(() => { func.apply(this, args); }, timeout);
        };
    }

    // --- ПОДКЛЮЧЕНИЕ СОБЫТИЙ ---

    // 1. Глобальный поиск на главной
    const globalInput = document.getElementById('globalSearchInput');
    if (globalInput) {
        globalInput.addEventListener('input', debounce(() => applyFilter('global'), 500));
    }

    // 2. Поиск и фильтры в сайдбаре
    const sidebarInput = document.getElementById('nameInput');
    if (sidebarInput) {
        // Текст
        sidebarInput.addEventListener('input', debounce(() => applyFilter('sidebar'), 500));
        // Цена
        document.getElementById('minPrice')?.addEventListener('input', debounce(() => applyFilter('sidebar'), 800));
        document.getElementById('maxPrice')?.addEventListener('input', debounce(() => applyFilter('sidebar'), 800));
        // Выпадающие списки (срабатывают сразу)
        document.getElementById('categorySelect')?.addEventListener('change', () => applyFilter('sidebar'));
        document.getElementById('sortSelect')?.addEventListener('change', () => applyFilter('sidebar'));
    }
</script>